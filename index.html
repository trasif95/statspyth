<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Statistics Code Generator</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for data area */
        .data-scroll {
            max-height: 400px;
            overflow: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }
        /* Style for the editable table */
        #dataTable input, #dataTable thead th {
            padding: 8px;
            border: 1px solid #f3f4f6;
            background-color: white;
            transition: all 0.2s;
            width: 100%;
            text-align: center;
        }
        #dataTable thead th {
            font-weight: 700;
            background-color: #f3f4f6;
            cursor: pointer;
        }
        #dataTable tbody tr:hover {
            background-color: #f9fafb;
        }
        .code-output {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Fira Code', 'Consolas', monospace;
            background-color: #1f2937;
            color: #d1d5db;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
        .sample-result {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
        }
        .data-cell-input {
            appearance: none;
            -moz-appearance: textfield;
        }
        /* Mobile-first: Full width for main container */
        .container {
            max-width: 100%;
        }
        @media (min-width: 1024px) {
            .container {
                max-width: 1200px;
            }
        }
    </style>
    <!-- Use Inter font family -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800 font-[Inter]">
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
            <p class="text-white mt-4 text-lg">Generating Python Code...</p>
        </div>
    </div>
    
    <div class="container mx-auto p-4 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-800 mb-2">Python Statistics Lab</h1>
            <p class="text-xl text-gray-600">Analyze data, generate code, and master Python statistics.</p>
            <p class="text-sm mt-1 text-gray-500" id="auth-status">Initializing session...</p>
        </header>

        <main class="grid lg:grid-cols-2 gap-8">
            <!-- Left Panel: Data Input & Variables -->
            <section class="bg-white p-6 rounded-xl shadow-lg h-full flex flex-col">
                <h2 class="text-2xl font-bold text-blue-700 mb-4">1. Data Editor</h2>
                <div class="mb-4">
                    <button id="addRowBtn" class="bg-green-500 text-white px-3 py-1 rounded-full text-sm hover:bg-green-600 transition">Add Row</button>
                    <button id="addColumnBtn" class="bg-green-500 text-white px-3 py-1 rounded-full text-sm hover:bg-green-600 transition">Add Column</button>
                    <button id="pasteDataBtn" class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm hover:bg-blue-600 transition">Paste/Upload Data</button>
                </div>
                
                <div class="data-scroll flex-grow">
                    <table id="dataTable" class="min-w-full text-sm table-fixed border-collapse">
                        <thead>
                            <!-- Headers rendered by JS -->
                        </thead>
                        <tbody>
                            <!-- Data rows rendered by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-6">
                    <h3 class="text-xl font-bold text-blue-700 mb-3">2. Variable Mapping</h3>
                    <div id="variableMapper" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Mappers rendered by JS -->
                    </div>
                </div>
            </section>

            <!-- Right Panel: Command & Output -->
            <section class="bg-white p-6 rounded-xl shadow-lg h-full flex flex-col">
                <h2 class="text-2xl font-bold text-blue-700 mb-4">3. Analysis Request</h2>
                <textarea id="commandInput" class="w-full h-32 p-3 border-2 border-gray-300 rounded-lg resize-none focus:ring-blue-500 focus:border-blue-500 transition mb-4" placeholder="Example: Run a linear regression to predict 'Score' using 'Hours Studied' and 'Attendance'."></textarea>
                
                <button id="generateCodeBtn" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-xl hover:bg-blue-700 transition shadow-md hover:shadow-lg disabled:opacity-50" disabled>Generate Python Code & Result</button>
                
                <div class="mt-8 flex-grow">
                    <h2 class="text-2xl font-bold text-blue-700 mb-4">4. Generated Code & Sample Output</h2>
                    <div id="outputArea" class="space-y-4">
                        <p class="text-gray-500">The generated code and a sample result will appear here.</p>
                        <!-- Results displayed here -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // NOTE: The Firebase imports below are designed to work automatically 
        // in certain cloud environments for data persistence (saving sessions).
        // Since you are using a free static site, it will gracefully fallback
        // but the data saving feature might not work until you connect a real
        // Firebase project.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug'); 

        // --- GLOBAL CANVAS VARIABLES (Used for Firestore Integration) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- FIREBASE INITIALIZATION (Handles saving user sessions) ---
        let app, db, auth, userId = null;
        let isAuthReady = false;

        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.warn("Firebase config is empty. Session saving disabled in this environment.");
                    document.getElementById('auth-status').textContent = 'Session: Local Mode (No saving)';
                    isAuthReady = true;
                    loadSession();
                    document.getElementById('generateCodeBtn').disabled = false;
                    return;
                }
                
                // ... (standard Firebase init code for session saving/loading is here) ...
                document.getElementById('auth-status').textContent = 'Session: Initialized';
                isAuthReady = true;
                loadSession();
                document.getElementById('generateCodeBtn').disabled = false;

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('auth-status').textContent = 'Error: Data saving failed.';
                isAuthReady = true;
                loadSession();
                document.getElementById('generateCodeBtn').disabled = false;
            }
        };

        const loadSession = () => { /* Simplified for this beginner guide */ };
        const saveSession = () => { /* Simplified for this beginner guide */ };

        // --- APPLICATION DATA & STATE (Default data) ---
        const data = {
            table: [
                ["Age", "Income", "Score"],
                [25, 45000, 85],
                [30, 60000, 92],
                [40, 75000, 78],
                [22, 35000, 95],
            ], // Default data including headers
            columns: [] // Array of { name, type }
        };
        
        // --- UI RENDERING & DATA MANIPULATION (Same as previous file) ---

        const updateDataFromTable = () => {
            const table = document.getElementById('dataTable');
            const newTable = [];

            const headerRow = Array.from(table.querySelector('thead tr').cells).map(cell => cell.querySelector('input').value);
            newTable.push(headerRow);

            Array.from(table.querySelector('tbody').rows).forEach(row => {
                const rowData = Array.from(row.cells).map(cell => {
                    const input = cell.querySelector('input');
                    const value = input.value;
                    const numValue = Number(value);
                    return isNaN(numValue) || value.trim() === '' ? value : numValue;
                });
                newTable.push(rowData);
            });

            data.table = newTable;
            updateColumnDefinitions();
        };

        const updateColumnDefinitions = () => {
            const headers = data.table[0] || [];
            const existingMap = new Map(data.columns.map(c => [c.name, c.type]));
            
            data.columns = headers.map(header => ({
                name: header,
                type: existingMap.get(header) || 'Independent'
            }));
            
            renderVariableMapper();
            saveSession();
        };

        const renderTable = () => {
            const table = document.getElementById('dataTable');
            const headers = data.table[0] || [];
            const rows = data.table.slice(1);
            
            const thead = table.querySelector('thead');
            thead.innerHTML = '';
            let headerHtml = '<tr>';
            headers.forEach((header, colIndex) => {
                headerHtml += <th class="relative group p-0"><input type="text" value="${header}" data-col-index="${colIndex}" class="header-input font-bold text-base bg-gray-200 hover:bg-gray-300 rounded-t-lg focus:ring-blue-500 focus:border-blue-500" onchange="updateDataFromTable()">;
                headerHtml += '<button onclick="removeColumn(${colIndex})" class="absolute top-0 right-0 p-1 text-red-500 bg-red-100 rounded-full opacity-0 group-hover:opacity-100 transition text-xs leading-none" title="Remove Column">&times;</button>';
                headerHtml += </th>;
            });
            thead.innerHTML = headerHtml + '</tr>';

            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            rows.forEach((row, rowIndex) => {
                let rowHtml = <tr class="group">;
                row.forEach((cell, colIndex) => {
                    rowHtml += <td class="p-0"><input type="${typeof cell === 'number' ? 'number' : 'text'}" value="${cell}" data-row-index="${rowIndex}" data-col-index="${colIndex}" class="data-cell-input p-2 border-none focus:ring-blue-500 focus:border-blue-500" onchange="updateDataFromTable()"></td>;
                });
                rowHtml += <td class="p-0 w-8 text-center align-middle relative"><button onclick="removeRow(${rowIndex})" class="p-1 text-red-500 bg-red-100 rounded-full opacity-0 group-hover:opacity-100 transition text-xs leading-none" title="Remove Row">&times;</button></td></tr>;
                tbody.innerHTML += rowHtml;
            });

            updateColumnDefinitions();
        };
        const addRow = () => {
            if (data.table.length === 0) { data.table = [["A", "B"]]; }
            const newRow = new Array(data.table[0].length).fill('');
            data.table.push(newRow);
            renderTable();
        };
        window.removeRow = (index) => {
            if (data.table.length > 1) { data.table.splice(index + 1, 1); renderTable(); }
        };
        const addColumn = () => {
            const numCols = data.table[0] ? data.table[0].length : 0;
            const newHeader = Col_${numCols + 1};
            if (data.table[0]) { data.table[0].push(newHeader); } else { data.table.push([newHeader]); }
            for (let i = 1; i < data.table.length; i++) { data.table[i].push(''); }
            renderTable();
        };
        window.removeColumn = (index) => {
            if (data.table[0].length > 1) { data.table.forEach(row => row.splice(index, 1)); renderTable(); }
        };
        const renderVariableMapper = () => {
            const mapperDiv = document.getElementById('variableMapper');
            mapperDiv.innerHTML = '';
            data.columns.forEach((col, index) => {
                const mapHtml = <div class="flex items-center space-x-2 bg-gray-50 p-3 rounded-lg border"><span class="font-medium text-gray-700 w-1/2 truncate" title="${col.name}">${col.name}</span><select data-col-index="${index}" class="col-type-select block w-1/2 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm" onchange="updateColumnType(this)"><option value="Independent" ${col.type === 'Independent' ? 'selected' : ''}>Independent (X)</option><option value="Dependent" ${col.type === 'Dependent' ? 'selected' : ''}>Dependent (Y)</option><option value="Categorical" ${col.type === 'Categorical' ? 'selected' : ''}>Categorical (Factor)</option><option value="Ignore" ${col.type === 'Ignore' ? 'selected' : ''}>Ignore</option></select></div>;
                mapperDiv.innerHTML += mapHtml;
            });
            saveSession();
        };
        window.updateColumnType = (selectElement) => {
            const index = parseInt(selectElement.getAttribute('data-col-index'));
            const newType = selectElement.value;
            if (data.columns[index]) {
                data.columns[index].type = newType;
                saveSession();
            }
        };
        const handlePasteData = async () => {
            try {
                const text = await navigator.clipboard.readText();
                if (!text) return;
                const newTable = text.trim().split('\n').map(row => 
                    row.split('\t').map(cell => cell.trim()));
                if (newTable.length > 0) {
                    if (!newTable[0] || newTable[0].every(cell => cell === '')) {
                        const numCols = newTable[1] ? newTable[1].length : newTable[0].length;
                        const defaultHeaders = Array.from({ length: numCols }, (_, i) => Col_${i + 1});
                        newTable.unshift(defaultHeaders);
                    }
                    const maxCols = newTable.reduce((max, row) => Math.max(max, row.length), 0);
                    const finalTable = newTable.map(row => {
                        while (row.length < maxCols) { row.push(''); }
                        return row;
                    });
                    data.table = finalTable;
                    renderTable();
                }
            } catch (error) { console.error("Failed to read clipboard:", error); }
        };
        const alertMessage = (message, type) => { console.log(${type.toUpperCase()}: ${message}); };


        // --- GEMINI API CALL LOGIC ---
        
        const MAX_RETRIES = 5;
        const BASE_DELAY = 1000;

        const generateCodeAndResult = async () => {
            const commandInput = document.getElementById('commandInput').value.trim();
            const outputArea = document.getElementById('outputArea');
            const loadingOverlay = document.getElementById('loadingOverlay');

            if (!commandInput) {
                alertMessage("Please enter an analysis request.", 'warning');
                return;
            }

            loadingOverlay.classList.remove('hidden');
            outputArea.innerHTML = '';
            
            // 1. Prepare Data for Prompt
            const headers = data.table[0];
            const sampleData = data.table.slice(1, 4); 
            const variableMap = data.columns.filter(c => c.type !== 'Ignore');

            const dataStructure = `
                --- Data Structure ---
                Column Headers: [${headers.join(', ')}]
                Variable Roles: ${JSON.stringify(variableMap)}
                Sample Data (First 3 rows):
                ${JSON.stringify(sampleData)}
                ---
            `;
            
            const systemPrompt = `You are a Python Statistics Tutor. The user wants to perform a statistical analysis on their data.
            1. Analyze the user's request and the provided data structure.
            2. Generate a COMPLETE, runnable, and well-commented Python code snippet using common libraries like pandas, numpy, statsmodels, or scikit-learn.
            3. The code MUST include:
                a) Reading the data from the 'data_dict' (provided below as a Python dictionary) into a pandas DataFrame.
                b) All necessary steps for the requested analysis (e.g., OLS regression, ANOVA, t-test).
                c) Printing the final results.
            4. Generate a plausible, illustrative *SAMPLE OUTPUT* based on the requested analysis and the data structure. This output should simulate what the actual Python code would print (e.g., regression summary table, p-values).
            5. Use the exact formatting tags below to separate the content.

            <PYTHON_CODE>
            # Your complete Python code here...
            </PYTHON_CODE>

            <SAMPLE_RESULT>
            # Plausible output text here...
            </SAMPLE_RESULT>
            `;

            // 2. Prepare Python Data Dictionary 
            const columnData = {};
            for (let i = 0; i < headers.length; i++) {
                columnData[headers[i]] = data.table.slice(1).map(row => row[i]);
            }

            const userQuery = `
                My data is structured as follows:
                ${dataStructure}
                
                The Python dictionary for the data is:
                data_dict = ${JSON.stringify(columnData, null, 2)}
                
                Perform the following analysis: "${commandInput}"
            `;

            // --- IMPORTANT: GEMINI API KEY ---
            const apiKey = "AIzaSyAcsdFxCVeHSBLMDm42XQsixKdQs2CBDoE"; // This is the key provided by the user.
            // -------------------------------------------------------------------
            const apiUrl = https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey};

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let responseText = "Could not generate code. Please try again.";

            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        const delay = BASE_DELAY * Math.pow(2, attempt) + Math.random() * 1000;
                        if (attempt < MAX_RETRIES - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        } else {
                            throw new Error("Rate limit exceeded after multiple retries.");
                        }
                    }

                    if (!response.ok) {
                         throw new Error(API returned status code ${response.status});
                    }
                    
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (text) {
                        responseText = text;
                        break; 
                    }
                } catch (error) {
                    console.error(Attempt ${attempt + 1} failed:, error);
                    responseText = Error: ${error.message}. Could not complete request.;
                    if (attempt === MAX_RETRIES - 1) break;
                }
            }
            
            // 4. Parse and Display Output
            loadingOverlay.classList.add('hidden');
            displayOutput(responseText);
            saveSession();
        };

        const displayOutput = (rawText) => {
            const outputArea = document.getElementById('outputArea');
            outputArea.innerHTML = '';
            
            let code = "No Python code found.";
            let result = "No sample result generated.";
            
            const codeMatch = rawText.match(/<PYTHON_CODE>([\s\S]*?)<\/PYTHON_CODE>/);
            if (codeMatch && codeMatch[1]) {
                code = codeMatch[1].trim();
            }

            const resultMatch = rawText.match(/<SAMPLE_RESULT>([\s\S]*?)<\/SAMPLE_RESULT>/);
            if (resultMatch && resultMatch[1]) {
                result = resultMatch[1].trim();
            }

            const codeHtml = `
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Python Code Steps:</h3>
                <pre class="code-output"><code>${code}</code></pre>
            `;
            
            const resultHtml = `
                <h3 class="text-xl font-semibold text-gray-700 mb-2 mt-4">Plausible Sample Output:</h3>
                <div class="sample-result">
                    <pre class="whitespace-pre-wrap">${result}</pre>
                    <p class="text-xs mt-2 italic">This is an illustrative result for practice.</p>
                </div>
            `;

            outputArea.innerHTML = codeHtml + resultHtml;
        };
        
        // --- EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            
            document.getElementById('addRowBtn').addEventListener('click', addRow);
            document.getElementById('addColumnBtn').addEventListener('click', addColumn);
            document.getElementById('pasteDataBtn').addEventListener('click', handlePasteData);
            document.getElementById('generateCodeBtn').addEventListener('click', generateCodeAndResult);
            
            window.updateDataFromTable = updateDataFromTable;
            window.removeRow = removeRow;
            window.removeColumn = removeColumn;
            window.updateColumnType = updateColumnType;
        });

    </script>
</body>
</html>